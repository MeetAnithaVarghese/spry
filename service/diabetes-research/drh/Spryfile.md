---
sqlpage-conf:
  database_url: "sqlite://DRH.cgmdata.sqlite.db?mode=rwc"
  web_root: "./dev-src.auto"
  allow_exec: true
  port: 9227
---

# Diabetes Research Hub (DRH) SQLPage Application

This script automates the conversion of raw diabetes research data (e.g.,
CSV, Parquet, or a private data warehouse export) into a structured SQLite database.

- Uses Spry to manage tasks and generate the SQLPage presentation layer.
- surveilr tool performs csv files conversation and transformation to RSSD
- Uses DuckDB for data transformation.(file meta ingest data,meal fitness data(if present),combined CGM data)
- Export back to sqlite db to be used in SQLpage

## Setup

Download your research data source (based on  the file format mentioned in  https://drh.diabetestechnology.org/organize-cgm-data ) and place it into the same
directory as this `README.md` and then run `spry.ts task prepare-db`. pass the study files folder name in the prepare-db task

```bash prepare-db --descr "Validates the data , Extract data from study files, Perform transformations through DuckDB and export to the SQLite database used by SQLPage"
#!/usr/bin/env -S bash
## example usage  ./run-drh-etl-surveilr.sh --data_path raw-data/flexi-cgm-study/ --tenant_id FLCG --tenant_name "FLCG" 
 ./run-drh-etl-surveilr.sh --data_path raw-data/flexi-cgm-study/ --tenant_id FLCG --tenant_name "FLCG" 

```

```bash
watchexec -e md -w Spryfile.md -- rm -rf dev-src.auto && ./spry.ts spc --fs dev-src.auto --conf sqlpage/sqlpage.json
```

- `-e md` — watch only Markdown files.
- `-w Spryfile.md` — limit watching to that specific file.
- The command after `--` runs every time `Spryfile.md` changes.

You would then run SQLPage server in one terminal while running the `watchexec`
in another terminal. If you want to do both in one terminal:

```bash
watchexec --shell=bash --restart -e md -w Spryfile.md -- \
  'set -Eeuo pipefail; rm -rf dev-src.auto && deno run -A ./spry.ts spc --fs dev-src.auto --conf sqlpage/sqlpage.json && SQLPAGE_SITE_PREFIX="" sqlpage'
```

## SQLPage single database deployment mode

After development is complete, the `dev-src.auto` can be removed and
single-database deployment can be used:

```bash deploy
rm -rf dev-src.auto
./spry.ts spc --package --conf sqlpage/sqlpage.json | sqlite3 DRH.cgmdata.sqlite.db
```

## Layout

This cell instructs Spry to automatically inject the SQL `PARTIAL` into all
SQLPage content cells. The name `global-layout.sql` is not significant (it's
required by Spry but just used for reference) but the `--inject **/*` argument
is how matching occurs. The `--BEGIN` and `--END` comments are not required by
Spry but makes it easier to trace where _partial_ injections are occurring.

```sql PARTIAL global-layout.sql --inject **/*

-- BEGIN: PARTIAL global-layout.sql
SELECT 'shell' AS component,
       'Diabetes Research Data Explorer' AS title,
       NULL AS icon,
       'https://drh.diabetestechnology.org/_astro/favicon.CcrFY5y9.ico' AS favicon,
       'https://drh.diabetestechnology.org/images/diabetic-research-hub-logo.png' AS image,
       'fluid' AS layout,
       true AS fixed_top_menu,
       'index.sql' AS link,
       '{"link":"/index.sql","title":"Home"}' AS menu_item;

SET resource_json = sqlpage.read_file_as_text('spry.d/auto/resource/${path}.auto.json');
SET page_title  = json_extract($resource_json, '$.route.caption');
-- END: PARTIAL global-layout.sql

```

## DRH EDGE  Home Page

Index page which automatically generates links to all `/drh` pages.
`navigation_node` is automatically generated by Spry.

```sql index.sql { route: { caption: "Home" } }
SET routes_json = sqlpage.read_file_as_text('spry.d/auto/route/forest.auto.json');
SET root_path   = '/drh';

SELECT 'card' AS component, '' AS title, 2 AS columns;
SELECT
  IFNULL(json_extract(c.value,'$.payloads[0].caption'),
         json_extract(c.value,'$.basename'))                         AS title,
  json_extract(c.value,'$.payloads[0].description')                  AS description_md,
  json_extract(c.value,'$.path')                                     AS link
FROM json_each(
       json_extract(
         (SELECT jt.value
          FROM json_tree(json($routes_json)) AS jt
          WHERE jt.type='object'
            AND json_extract(jt.value,'$.path') = $root_path
          LIMIT 1),
         '$.children'
       )
     ) AS c
WHERE IFNULL(json_extract(c.value,'$.virtual'), 0) <> 1;
```